name: update-dotnet-sdks

on:
  repository_dispatch:
    types: [ dotnet_release ]
  workflow_dispatch:
    inputs:
      branch:
        description: "The branch to run the SDK updates for."
        required: false
        type: choice
        options:
          - "main"
          - "dotnet-vnext"
        default: "main"

permissions: {}

jobs:
  update-dotnet-sdks:
    runs-on: [ ubuntu-latest ]
    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false
    steps:
      - name: Update .NET SDKs
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          $branch = "${{ inputs.branch || 'main' }}"
          $repos = @(
            "justeattakeaway/ApplePayJSSample",
            "justeattakeaway/httpclient-interception",
            "justeattakeaway/JustEat.StatsD",
            "justeattakeaway/JustSaying",
            "martincostello/adventofcode",
            "martincostello/alexa-london-travel",
            "martincostello/alexa-london-travel-site",
            "martincostello/antiforgery-testing-application-part",
            "martincostello/api",
            "martincostello/apple-fitness-workout-mapper",
            "martincostello/aspnet-core-pseudo-localization",
            "martincostello/browserstack-automate",
            "martincostello/costellobot",
            "martincostello/dependabot-helper",
            "martincostello/dotnet-minimal-api-integration-testing",
            "martincostello/dotnet-patch-automation-sample",
            "martincostello/dotnet-playwright-tests",
            "martincostello/dotnet-repo-template",
            "martincostello/github-automation",
            "martincostello/home",
            "martincostello/lambda-test-server",
            "martincostello/polly-rate-limiting",
            "martincostello/project-euler",
            "martincostello/Pseudolocalizer",
            "martincostello/SignInWithAppleSample",
            "martincostello/sqllocaldb",
            "martincostello/website",
            "martincostello/xunit-logging"
          )
          foreach ($repo in $repos) {
            gh api "repos/${repo}/branches/${branch}" | Out-Null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::Debug::Skipping ${repo} as the ${branch} branch does not exist."
              continue
            }
            gh workflow run "update-dotnet-sdk.yml" --ref $branch --repo $repo
            Start-Sleep -Seconds 10 # Wait 10 seconds to prevent issues with GitHub secondary rate limits
          }
          exit 0
