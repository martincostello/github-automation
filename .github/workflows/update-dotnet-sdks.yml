name: update-dotnet-sdks

on:
  repository_dispatch:
    types: [ dotnet_release ]
  workflow_call:
    inputs:
      branch:
        description: 'The branch to run the SDK updates for.'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to run the SDK updates for.'
        required: false
        type: choice
        options:
          - 'main'
          - 'dotnet-vnext'
          - 'dotnet-nightly'
        default: 'main'

permissions: {}

jobs:
  get-repos:
    runs-on: [ ubuntu-latest ]

    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false

    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}

    steps:
      - name: Get repositories
        id: get-repos
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          # TODO Query repositories for the same owner for those that contain a global.json file
          # Then iterate through ignoring forks and those that are archived and apply any custom config on top of that
          # Need to check that the input branch actually exists if it's not main.
          $contents = gh api "repos/${{ github.repository }}/contents/.github/workflow-config.json?ref=${{ github.sha }}" | ConvertFrom-Json
          $repos = ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($contents.content)) | ConvertFrom-Json).repositories
          $filteredRepos = @()
          foreach ($repo in $repos) {
            if ($repo.StartsWith("${{ github.repository_owner }}/")) {
              $filteredRepos += $repo
            }
          }
          $reposJson = ConvertTo-Json $filteredRepos -Compress
          "repos=${reposJson}" >> $env:GITHUB_OUTPUT

  update-sdk:
    name: 'rebase-${{ matrix.repo }}'
    needs: get-repos
    if: ${{ needs.get-repos.outputs.repos != '[]' }}
    uses: martincostello/update-dotnet-sdk/.github/workflows/update-dotnet-sdk.yml@dff4a89c9023c82ab5ef78ac8d275fc908456bd3 # v2.3.1

    concurrency:
      group: 'update-sdk-${{ matrix.repo }}'
      cancel-in-progress: false

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        repo: ${{ fromJSON(needs.get-repos.outputs.repos) }}

    # costellobot will need a custom trigger for the below to update SignalR:
    # on:
    #   pull_request: [ update-dotnet-sdk-* ]
    with:
      checkout-ref: ${{ (github.event.client_payload && github.event.client_payload.branch) || inputs.branch || 'main' }}
      labels: 'dependencies,.NET'
      quality: ${{ ((github.event.client_payload && github.event.client_payload.branch) || inputs.branch) == 'dotnet-nightly' && 'daily' || '' }}
      repo: ${{ matrix.repo }}
      user-email: ${{ vars.GIT_COMMIT_USER_EMAIL }}
      user-name: ${{ vars.GIT_COMMIT_USER_NAME }}
    secrets:
      repo-token: ${{ secrets.ACCESS_TOKEN }}
