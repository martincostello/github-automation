name: update-dotnet-sdks

on:
  repository_dispatch:
    types: [ dotnet_release ]
  workflow_call:
    inputs:
      branch:
        description: "The branch to run the SDK updates for."
        required: true
        type: string
  workflow_dispatch:
    inputs:
      branch:
        description: "The branch to run the SDK updates for."
        required: false
        type: choice
        options:
          - "main"
          - "dotnet-vnext"
          - "dotnet-nightly"
        default: "main"

permissions: {}

jobs:
  update-dotnet-sdks:
    runs-on: [ ubuntu-latest ]
    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false
    steps:
      - name: Update .NET SDKs
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          $branch = "${{ (github.event.client_payload && github.event.client_payload.branch) || inputs.branch || 'main' }}"

          $response = gh api "repos/${{ github.repository }}/contents/.github/workflow-config.json?ref=${{ github.sha }}" | ConvertFrom-Json
          $repos = ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($contents.content)) | ConvertFrom-Json).repositories

          foreach ($repo in $repos) {
            gh api "repos/${repo}/branches/${branch}" 2> $null | Out-Null
            if ($LASTEXITCODE -ne 0) {
              Write-Output "::Debug::Skipping ${repo} as the ${branch} branch does not exist."
              continue
            }
            gh workflow run "update-dotnet-sdk.yml" --ref $branch --repo $repo
            Start-Sleep -Seconds 10 # Wait 10 seconds to prevent issues with GitHub secondary rate limits
          }
          exit 0
