name: acr-housekeeping

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions: {}

env:
  FORCE_COLOR: 3
  TERM: xterm

jobs:
  purge:
    runs-on: ubuntu-latest

    environment:
      name: azure

    permissions:
      id-token: write

    steps:

    - name: Azure log in
      uses: azure/login@6b2456866fc08b011acb422a92a4aa20e2c4de32 # v2.1.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Purge old images
      shell: pwsh
      env:
        CONTAINER_REGISTRY: '${{ github.repository_owner }}.azurecr.io'
      run: |
        $purgeCommand = "acr purge --filter '.*:.*' --ago 1d --keep 2 --untagged --dry-run"
        az acr run --cmd $purgeCommand --registry ${env:CONTAINER_REGISTRY} /dev/null
